rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ========================================
    // HELPER FUNCTIONS
    // ========================================

    // Check if user is authenticated
    function isAuth() {
      return request.auth != null;
    }

    // Get user document for current auth user
    // Tries to find by document ID first (preferred), returns null if not found
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    // Check if user document exists with this auth UID as document ID
    function userDocExists() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    // Check if current user is an Admin
    // User is admin if their document (by auth UID) has role == 'admin'
    function isAdmin() {
      // Allow if valid admin doc exists OR if email is the hardcoded admin
      return isAuth() && (
        (userDocExists() && getUserData().role == 'admin') ||
        request.auth.token.email == 'admin@thefieldhub.web.app' || 
        request.auth.token.email.matches('.*@thefieldhub[.]web[.]app')
      );
    }

    // Check if current user is a Field Worker
    function isField() {
      return isAuth() && userDocExists() && getUserData().role == 'field';
    }

    // Check if user is the owner of a document (by userId field)
    function isOwner(userId) {
      return isAuth() && request.auth.uid == userId;
    }

    // ========================================
    // VALIDATION FUNCTIONS
    // ========================================

    function isValidEmail(email) {
      return email.matches('^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$');
    }

    function isValidPhone(phone) {
      return phone.matches('^[0-9]{10}$');
    }

    // ========================================
    // COLLECTION RULES
    // ========================================

    // --- PUBLIC REGISTRATIONS ---
    // Anyone can submit a registration; only admins can read/update/delete
    match /registrations/{docId} {
      allow create: if true; // Public registration form
      allow read, update, delete: if isAdmin();
    }

    // --- USERS ---
    // Admins can CRUD; Field workers can read all (for team view) and update only their own profile
    match /users/{userId} {
      allow read: if isAuth();
      allow create, delete: if isAdmin();
      allow update: if isAdmin() || isOwner(userId);
    }

    // --- PROJECTS ---
    // All authenticated users can read; only admins can write
    match /projects/{docId} {
      allow read: if isAuth();
      allow write: if isAdmin();
    }

    // --- SITES ---
    // All authenticated users can read; only admins can write
    // Relaxed validation: Removed strict number check since forms may send strings
    match /sites/{docId} {
      allow read: if isAuth();
      allow create, update, delete: if isAdmin();
    }

    // --- TASKS ---
    // Admins can CRUD; Field workers can read their own tasks and update status only
    match /tasks/{docId} {
      allow read: if isAuth();
      allow create, delete: if isAdmin();
      allow update: if isAdmin() || (isOwner(resource.data.assignedTo) && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'completedAt']));
    }

    // --- ATTENDANCE (Live Status) ---
    // Field workers can update their own status; admins can read all
    match /attendance/{userId} {
      allow read: if isAuth();
      allow write: if isAdmin() || isOwner(userId);
    }

    // --- ATTENDANCE LOGS (Immutable History) ---
    // Field workers can create their own logs (append-only); NO ONE can update/delete (immutability)
    match /attendanceLogs/{docId} {
      allow read: if isAuth();
      allow create: if isAuth() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if false; // Logs are immutable
    }

    // --- LEAVE REQUESTS ---
    // Field workers can create/read their own; admins can read/update all
    match /leaveRequests/{docId} {
      allow read: if isAuth();
      allow create: if isAuth() && request.resource.data.userId == request.auth.uid;
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // --- REPORTS ---
    // Field workers can create their own reports; admins can read/delete all
    match /reports/{docId} {
      allow read: if isAuth();
      allow create: if isAuth() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAdmin();
    }

    // --- MESSAGES (Chat) ---
    // All authenticated users can read and create messages
    match /messages/{docId} {
      allow read, create: if isAuth();
      allow update, delete: if isAdmin();
    }
  }
}